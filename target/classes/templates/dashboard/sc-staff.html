<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    th:replace="~{layout :: html(content=~{::content}, pageTitle='Bảng điều khiển Trung tâm Dịch vụ')}">

<body>
    <div th:fragment="content">
        <!-- Stats Grid - Dynamic with API -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon primary">
                    <i class="fas fa-car"></i>
                </div>
                <div class="stat-content">
                    <h3>Tổng xe</h3>
                    <div class="stat-value" id="stat-total-vehicles">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon warning">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-content">
                    <h3>Yêu cầu chờ duyệt</h3>
                    <div class="stat-value" id="stat-pending-claims">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon info">
                    <i class="fas fa-wrench"></i>
                </div>
                <div class="stat-content">
                    <h3>Đang sửa chữa</h3>
                    <div class="stat-value" id="stat-in-progress">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon success">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-content">
                    <h3>Hoàn thành</h3>
                    <div class="stat-value" id="stat-completed">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card mb-3">
            <div class="card-header">
                <h3 class="card-title">Thao tác nhanh</h3>
            </div>
            <div class="btn-group" style="flex-wrap: wrap; padding: 1rem;">
                <a th:href="@{/sc/vehicles/new}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Đăng ký xe
                </a>
                <a th:href="@{/sc/claims/new}" class="btn btn-secondary">
                    <i class="fas fa-file-invoice"></i> Tạo yêu cầu bảo hành
                </a>
                <a th:href="@{/sc/customers/new}" class="btn btn-secondary">
                    <i class="fas fa-user-plus"></i> Thêm khách hàng
                </a>
                <a th:href="@{/sc/inventory}" class="btn btn-secondary">
                    <i class="fas fa-boxes"></i> Kho
                </a>
            </div>
        </div>

        <!-- Recent Vehicles Table (API Loaded) -->
        <div class="card mb-3">
            <div class="card-header d-flex justify-between align-center">
                <h3 class="card-title">Xe mới đăng ký</h3>
                <a th:href="@{/sc/vehicles}" class="btn btn-sm btn-secondary">Xem tất cả</a>
            </div>
            <div class="table-container">
                <table id="recent-vehicles-table">
                    <thead>
                        <tr>
                            <th>Số VIN</th>
                            <th>Hãng / Mẫu xe</th>
                            <th>Năm</th>
                            <th>Khách hàng</th>
                            <th>Trạng thái</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="5" class="text-center">
                                <i class="fas fa-spinner fa-spin"></i> Đang tải...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Recent Claims Table (API Loaded) -->
        <div class="card">
            <div class="card-header d-flex justify-between align-center">
                <h3 class="card-title">Yêu cầu bảo hành gần đây</h3>
                <a th:href="@{/sc/claims}" class="btn btn-sm btn-secondary">Xem tất cả</a>
            </div>
            <div class="table-container">
                <table id="recent-claims-table">
                    <thead>
                        <tr>
                            <th>Mã yêu cầu</th>
                            <th>Xe</th>
                            <th>Trạng thái</th>
                            <th>Mô tả</th>
                            <th>Ngày tạo</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="5" class="text-center">
                                <i class="fas fa-spinner fa-spin"></i> Đang tải...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Dashboard AJAX Script -->
    <script th:inline="javascript">
        $(function() {
            // Load dashboard stats from API
            loadDashboardStats();
            loadRecentVehicles();
            loadRecentClaims();

            // Refresh every 30 seconds
            setInterval(function() {
                loadDashboardStats();
            }, 30000);
        });

        function loadDashboardStats() {
            API.Reports.getDashboard()
                .then(function(response) {
                    if (response.success && response.data) {
                        var stats = response.data;
                        $('#stat-total-vehicles').text(stats.totalVehicles || 0);
                        $('#stat-pending-claims').text(stats.pendingClaims || 0);
                        $('#stat-in-progress').text(stats.inProgressClaims || 0);
                        $('#stat-completed').text(stats.completedClaims || 0);
                    }
                })
                .catch(function(error) {
                    console.error('Failed to load stats:', error);
                    $('#stat-total-vehicles, #stat-pending-claims, #stat-in-progress, #stat-completed').text('-');
                });
        }

        function loadRecentVehicles() {
            API.Vehicles.getAll(0, 5)
                .then(function(response) {
                    if (response.success && response.data) {
                        renderVehiclesTable(response.data);
                    }
                })
                .catch(function(error) {
                    $('#recent-vehicles-table tbody').html(
                        '<tr><td colspan="5" class="text-center text-danger">Lỗi: ' + error.message + '</td></tr>'
                    );
                });
        }

        function renderVehiclesTable(vehicles) {
            var $tbody = $('#recent-vehicles-table tbody');
            $tbody.empty();

            if (!vehicles || vehicles.length === 0) {
                $tbody.html('<tr><td colspan="5" class="text-center text-muted">Chưa có xe nào</td></tr>');
                return;
            }

            vehicles.forEach(function(v) {
                var statusClass = 'status-' + (v.status ? v.status.toLowerCase() : 'active');
                var row = '<tr>' +
                    '<td><a href="/sc/vehicles/' + v.id + '">' + v.vin + '</a></td>' +
                    '<td>' + v.make + ' ' + v.model + '</td>' +
                    '<td>' + v.year + '</td>' +
                    '<td>' + (v.customer ? v.customer.fullName : 'N/A') + '</td>' +
                    '<td><span class="badge ' + statusClass + '">' + v.status + '</span></td>' +
                    '</tr>';
                $tbody.append(row);
            });
        }

        function loadRecentClaims() {
            API.Claims.getAll(0, 5)
                .then(function(response) {
                    if (response.success && response.data) {
                        renderClaimsTable(response.data);
                    }
                })
                .catch(function(error) {
                    $('#recent-claims-table tbody').html(
                        '<tr><td colspan="5" class="text-center text-danger">Lỗi: ' + error.message + '</td></tr>'
                    );
                });
        }

        function renderClaimsTable(claims) {
            var $tbody = $('#recent-claims-table tbody');
            $tbody.empty();

            if (!claims || claims.length === 0) {
                $tbody.html('<tr><td colspan="5" class="text-center text-muted">Chưa có yêu cầu nào</td></tr>');
                return;
            }

            claims.forEach(function(c) {
                var statusClass = 'status-' + (c.status ? c.status.toLowerCase().replace('_', '-') : 'draft');
                var row = '<tr>' +
                    '<td><a href="/sc/claims/' + c.id + '">' + c.claimNumber + '</a></td>' +
                    '<td>' + (c.vehicle ? c.vehicle.vin : 'N/A') + '</td>' +
                    '<td><span class="badge ' + statusClass + '">' + c.status + '</span></td>' +
                    '<td>' + truncate(c.failureDescription, 40) + '</td>' +
                    '<td>' + API.UI.formatDate(c.createdAt) + '</td>' +
                    '</tr>';
                $tbody.append(row);
            });
        }

        function truncate(str, len) {
            if (!str) return '-';
            return str.length > len ? str.substring(0, len) + '...' : str;
        }
    </script>
</body>

</html>