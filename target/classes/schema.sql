-- Schema for EV Warranty System
-- Tables created in dependency order to avoid FK issues

-- Base tables (no foreign keys)
CREATE TABLE IF NOT EXISTS roles (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR(50) NOT NULL UNIQUE,
    description VARCHAR(255),
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);

CREATE TABLE IF NOT EXISTS users (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    full_name VARCHAR(100) NOT NULL,
    email VARCHAR(100) NOT NULL UNIQUE,
    phone VARCHAR(20),
    service_center VARCHAR(100),
    active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    last_login TIMESTAMP
);

CREATE TABLE IF NOT EXISTS user_roles (
    user_id BIGINT NOT NULL,
    role_id BIGINT NOT NULL,
    PRIMARY KEY (user_id, role_id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (role_id) REFERENCES roles(id)
);

CREATE TABLE IF NOT EXISTS customers (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    full_name VARCHAR(100) NOT NULL,
    email VARCHAR(100) NOT NULL UNIQUE,
    phone VARCHAR(20),
    address VARCHAR(255),
    city VARCHAR(100),
    state VARCHAR(100),
    zip_code VARCHAR(20),
    country VARCHAR(100),
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);

CREATE TABLE IF NOT EXISTS parts (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    part_number VARCHAR(50) NOT NULL UNIQUE,
    name VARCHAR(200) NOT NULL,
    description VARCHAR(10000),
    category VARCHAR(30),
    price DECIMAL(10,2),
    warranty_months INT,
    manufacturer VARCHAR(100),
    is_active BOOLEAN DEFAULT TRUE,
    min_stock_level INT,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);

CREATE TABLE IF NOT EXISTS warranty_policies (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description VARCHAR(10000),
    duration_months INT,
    mileage_limit INT,
    coverage_type VARCHAR(30),
    deductible DECIMAL(10,2),
    applicable_models VARCHAR(500),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);

CREATE TABLE IF NOT EXISTS vehicles (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    vin VARCHAR(17) NOT NULL UNIQUE,
    model VARCHAR(100) NOT NULL,
    make VARCHAR(100) NOT NULL,
    year INT NOT NULL,
    color VARCHAR(50),
    battery_type VARCHAR(50),
    battery_capacity DOUBLE,
    motor_type VARCHAR(50),
    mileage INT,
    manufacture_date DATE,
    purchase_date DATE,
    registration_date DATE,
    warranty_start_date DATE,
    warranty_end_date DATE,
    status VARCHAR(20) DEFAULT 'ACTIVE',
    customer_id BIGINT,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    FOREIGN KEY (customer_id) REFERENCES customers(id)
);

CREATE TABLE IF NOT EXISTS vehicle_parts (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    serial_number VARCHAR(100) UNIQUE,
    vehicle_id BIGINT NOT NULL,
    part_id BIGINT NOT NULL,
    installation_date DATE,
    warranty_start_date DATE,
    warranty_end_date DATE,
    status VARCHAR(20) DEFAULT 'INSTALLED',
    notes VARCHAR(10000),
    installed_by BIGINT,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    FOREIGN KEY (vehicle_id) REFERENCES vehicles(id),
    FOREIGN KEY (part_id) REFERENCES parts(id),
    FOREIGN KEY (installed_by) REFERENCES users(id)
);

CREATE TABLE IF NOT EXISTS warranty_claims (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    claim_number VARCHAR(20) NOT NULL UNIQUE,
    vehicle_id BIGINT NOT NULL,
    vehicle_part_id BIGINT,
    warranty_policy_id BIGINT,
    status VARCHAR(20) DEFAULT 'DRAFT',
    failure_description VARCHAR(10000) NOT NULL,
    diagnosis_notes VARCHAR(10000),
    repair_description VARCHAR(10000),
    labor_hours DOUBLE,
    labor_cost DECIMAL(10,2),
    parts_cost DECIMAL(10,2),
    total_cost DECIMAL(10,2),
    mileage_at_claim INT,
    service_center VARCHAR(100),
    submitted_by BIGINT,
    technician_id BIGINT,
    reviewed_by BIGINT,
    submitted_at TIMESTAMP,
    reviewed_at TIMESTAMP,
    completed_at TIMESTAMP,
    rejection_reason VARCHAR(10000),
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    FOREIGN KEY (vehicle_id) REFERENCES vehicles(id),
    FOREIGN KEY (vehicle_part_id) REFERENCES vehicle_parts(id),
    FOREIGN KEY (warranty_policy_id) REFERENCES warranty_policies(id),
    FOREIGN KEY (submitted_by) REFERENCES users(id),
    FOREIGN KEY (technician_id) REFERENCES users(id),
    FOREIGN KEY (reviewed_by) REFERENCES users(id)
);

CREATE TABLE IF NOT EXISTS claim_attachments (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    warranty_claim_id BIGINT NOT NULL,
    file_name VARCHAR(255) NOT NULL,
    file_path VARCHAR(500) NOT NULL,
    file_type VARCHAR(50),
    file_size BIGINT,
    attachment_type VARCHAR(30),
    description VARCHAR(10000),
    uploaded_by BIGINT,
    created_at TIMESTAMP,
    FOREIGN KEY (warranty_claim_id) REFERENCES warranty_claims(id),
    FOREIGN KEY (uploaded_by) REFERENCES users(id)
);

CREATE TABLE IF NOT EXISTS service_campaigns (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    campaign_number VARCHAR(20) NOT NULL UNIQUE,
    title VARCHAR(200) NOT NULL,
    description VARCHAR(10000),
    campaign_type VARCHAR(20) NOT NULL,
    status VARCHAR(20) DEFAULT 'DRAFT',
    severity_level VARCHAR(20) DEFAULT 'LOW',
    affected_models VARCHAR(500),
    affected_vins VARCHAR(10000),
    affected_parts VARCHAR(500),
    remedy_description VARCHAR(10000),
    estimated_repair_time DOUBLE,
    start_date DATE,
    end_date DATE,
    total_affected INT,
    completed_count INT DEFAULT 0,
    created_by BIGINT,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    FOREIGN KEY (created_by) REFERENCES users(id)
);

CREATE TABLE IF NOT EXISTS inventory (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    service_center VARCHAR(100) NOT NULL,
    part_id BIGINT NOT NULL,
    quantity_on_hand INT DEFAULT 0,
    quantity_reserved INT DEFAULT 0,
    reorder_point INT DEFAULT 0,
    reorder_quantity INT DEFAULT 0,
    last_restock_date TIMESTAMP,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    FOREIGN KEY (part_id) REFERENCES parts(id)
);

CREATE TABLE IF NOT EXISTS service_history (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    vehicle_id BIGINT NOT NULL,
    service_type VARCHAR(30) NOT NULL,
    description VARCHAR(10000),
    service_center VARCHAR(100),
    technician_id BIGINT,
    mileage_at_service INT,
    labor_hours DOUBLE,
    cost DECIMAL(10,2),
    warranty_claim_id BIGINT,
    service_campaign_id BIGINT,
    service_date TIMESTAMP,
    completion_date TIMESTAMP,
    notes VARCHAR(10000),
    created_at TIMESTAMP,
    FOREIGN KEY (vehicle_id) REFERENCES vehicles(id),
    FOREIGN KEY (technician_id) REFERENCES users(id),
    FOREIGN KEY (warranty_claim_id) REFERENCES warranty_claims(id),
    FOREIGN KEY (service_campaign_id) REFERENCES service_campaigns(id)
);
